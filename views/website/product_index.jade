extend ../layout_website

block content
  .layout
    .lCol.lCol_website
      include ./_say_hi
      include ./_new_articles
    .main
      #products_filter
        ul
          - filter = $.copy(config.product);
          - filter.price = {key:'价格范围',data:['1-999','1000-1999','2000-2999','3000-3999','4000-4999','5000以上']}
          - for(var key in filter){
            - item = filter[key]
            li
              span.key= item.key + ":"
              unless key in query
                b(style="color:red;") 不限
              else
                a(href="#", data-filter="#{key}=") 不限

              each option in item.data
                if query[key] == option
                  b(style="color:red;")= option
                else
                  a(href="#", data-filter="#{key}=#{option}")= option
          - }
      include ./_products_show
      include ../pages

  script(type="text/javascript")
    // $todo:用对象的方法重写此段逻辑。
    seajs.use("$", function($){
      $(function(){
        var boxFilter = $('#products_filter');
        boxFilter.on('click', 'a', function(e){
          var filter = $(this).attr('data-filter');
          var key = filter.split('=')[0];
          var value = filter.split('=')[1];
          var regr = new RegExp('([\?&])'+key+'=[^&]+(?=&|$)');
          var ismatch = regr.test(location.href);
          var redirect;
          if(ismatch){
            if(value === ''){
              redirect = location.href.replace(regr, function(a,b){
                if(b == '?')
                  return '?';
                else
                  return '';
              })
              redirect = redirect.replace('?&', '?');
            }else {
              redirect = location.href.replace(regr, function(a,b){
                if(b == '?')
                  return '?' + filter;
                else
                  return '&' + filter;
              });
            }
          }else {
            redirect = location.href + (location.href.indexOf('?')>0?'&':'?') + filter;
            redirect = redirect.replace('?&', '?');
            redirect = redirect.replace(/&page=\d+|\?page=\d+$/,'');
          }
          location.href = redirect;
          return false;
        });
      });
    })